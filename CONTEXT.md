# Context - bkl Project

## Documentation Improvements Made (2025-06-29)
- Simplified language throughout sections.yaml for clarity
- Removed Docker section (not common usage pattern)
- Fixed JSON Lines references to use "(see [JSON Lines])" format
- Removed colons from section content lines
- Made sentence fragments into full sentences
- Reordered encode operations alphabetically
- Added sha256 and values encoding examples
- Preserved installation hints for brew and go
- Labeled brew as (macOS) since go install works on all platforms
- Changed "Error Handling" section title to "Errors"
- Reverted comparison and migration sections to original content
- Added $defer directive for post-processing operations
- Updated to use PopMapBoolValue/PopListMapBoolValue for directive detection
- Renamed docs/sections.yaml to docs/index.yaml for better naming convention
- Updated generate.go to support multiple YAML files in docs directory

## CRITICAL INSTRUCTIONS - MUST FOLLOW

1. **No wrappers**: NEVER create wrapper files that just re-export from other packages. Always update callers directly to use the new import paths.

2. **Remember Rule**: When the user says "remember", IMMEDIATELY update this file to move the rule that needs to be remembered to the top of this CRITICAL INSTRUCTIONS section.

3. **Minimal comments**: Only add comments when absolutely critical for disambiguation

4. **Simple commits**: One-line commit messages ONLY. NEVER add "Generated by Claude" footers, emojis, or any multi-line messages. Just describe what changed in one line.

5. **Commit**: When asked to "commit", do: 1) update CONTEXT.md if needed, 2) run all tests with `just`, 3) stage changes with `git add -A`, 4) commit with simple message, 5) push with `git push`

6. **Never use `go build`**: Always use `go run` instead of `go build` for testing Go programs

7. **Use MCP servers for Go development**: 
   - Use language-server MCP methods to read/write Go files and find symbols
   - Use bkl-mcp MCP methods to query documentation and search through tests
   - Never use direct file operations when MCP servers provide the functionality

8. **Test management**: 
   - MUST run all tests before moving on to add any new tests
   - MUST check with the user before moving on to add any new tests
   - MUST check with the user before deleting any tests

9. **Error handling**: Always propagate errors with proper messages, never silently handle errors

10. **No one-off scripts**: Never create temporary test scripts, always use inline debugging

11. **Never run bkl manually**: Never run `bkl` manually for testing - always use `just` or test commands

12. **Never change directories**: Never change directories with `cd` - always use absolute paths instead

## Project Overview
bkl is a flexible configuration templating language that simplifies configuration management across environments. Key capabilities:
- **Multi-format support**: Handles YAML, JSON, TOML seamlessly
- **Automatic inheritance**: Uses filename patterns (e.g., `service.test.yaml` inherits from `service.yaml`)
- **Manual inheritance**: Via `$parent` directives and wildcard patterns
- **Intelligent merging**: Maps and lists merge by default, with override options
- **String interpolation**: `$"Hello {variable}"` syntax for dynamic values
- **Environment variables**: `$env:VAR` for runtime configuration
- **Transformations**: `$encode`, `$decode`, `$merge` for data manipulation
- **Stream processing**: Handle multiple documents with `$match` and `$output`
- **Utility features**: `$repeat`, `$delete`, `$replace`, required field validation

## Testing Framework
- **Language tests** (`tests.toml` file):
  - All tests now use the centralized language test framework
  - Test definitions in TOML format (301 tests as of latest count, including benchmarks)
  - Each test specifies: `description`, `eval` (file to evaluate), `format` (output format), `expected` (expected output), `files` (map of filename to content)
  - Special test modes: `diff = true` (bkld), `intersect = true` (bkli), `required = true` (bklr)
  - Run with `go test -run TestLanguage`
  - Run specific tests with `go test -run TestLanguage -test.filter=test1,test2,test3`
  - Exclude specific tests with `go test -test.exclude=test1,test2` 
  - Run benchmarks with `go test -bench=BenchmarkLanguage`
  - Tests run in parallel with in-memory filesystem (fstest.MapFS)
  - Test names use camelCase convention
  - Test execution uses switch statement for different modes (evaluate, diff, intersect, required)
  - Support for `benchmark = true` to run tests as benchmarks (automatically skipped in normal test runs)
  - Organized into well-defined sections:
    - Delete Operations ($delete)
    - Replace Operations ($replace) 
    - Merge Operations ($merge)
    - Match Operations ($match)
    - List Operations
    - Encoding Operations ($encode)
    - Decoding Operations ($decode)
    - String Interpolation
    - Repeat Operations ($repeat)
    - Output Control ($output)
    - Parent and Inheritance ($parent)
    - Format Support and Type Handling
    - Special Characters and Escaping
    - Diff Operations (bkld)
    - Intersect Operations (bkli)
    - Required Field Extraction (bklr)
    - Defer Operations ($defer)
    - Performance Benchmarks
- **Test naming**: Use descriptive names without "bug", "debug", or "tmp" (tests are kept permanently)
  - Use "null" not "nil" in test names (language perspective vs implementation)
  - Use short values in tests: a/b/c, 1/2/3, x/y/z instead of full words
- **Current test coverage**: 87.8%

## Key Files and Architecture
- `file.go`: File loading and parent resolution
- `document.go`: Document structure and processing
- `parser.go`: Main parser logic and document merging (uses fs.FS with working directory support)
- `process1.go`/`process2.go`: Document processing phases
- `merge.go`: Merge logic for combining documents and handling type conflicts
- `diff.go`: Diff functionality for bkld (comparing two documents)
- `intersect.go`: Intersect functionality for bkli (finding common elements)
- `required.go`: Required field extraction for bklr (filtering to $required markers)
- `yaml.go`: YAML parsing using standard library decoder
- `error.go`: Centralized error definitions with base `Err`
- `fs.go`: Filesystem abstraction with working directory support and glob fixes
- `filepath.go`: File path utilities and extension handling
- `language_test.go`: Go test wrapper for tests.toml-based language tests (package bkl_test)

## Error Handling Patterns
- All errors inherit from base `Err` using `fmt.Errorf("message (%w)", Err)`
- Existing error types: `ErrCircularRef`, `ErrMissingFile`, `ErrVariableNotFound`, etc.
- Tests expecting failures use `! bkl` and empty expected output

## Code Style Observations
- Uses standard library `slices` package for modern Go idioms
- Error messages include context (file paths, variable names)
- Consistent naming: functions use camelCase, test directories use kebab-case
- Import organization: standard library first, then third-party

## Development Expectations
- **Minimal comments**: Only add comments when absolutely critical for disambiguation
- **Standard library preferred**: Use `slices.Contains()` instead of hand-rolled loops
- **Proper error handling**: Use `io.EOF` comparison, not string matching
- **Clean imports**: Remove unused imports, organize standard library first
- **Test-driven**: Write tests for new features before implementing them, and tests that demonstrate problems before fixing them
- **Standards compliance**: Prefer standard library implementations over custom parsing
- **Code quality**: The linter (`gofumpt`, `go vet`) will automatically format code
- **Comprehensive testing**: Use `just` to run the full test pipeline before committing
- **Configuration errors should fail with proper error messages, not silent success**
- **File maintenance**: Clean up and reorganize CONTEXT.md sections as needed during updates
- **No line numbers**: Don't cite specific line numbers in documentation as they become stale
- **No implementation details**: Don't describe specific implementation details that change with code
## MCP Servers Available
- **bkl-mcp** (Model Context Protocol server for documentation and test queries):
  - `query` - Unified query for bkl documentation and test examples by keywords (comma-separated)
    - Returns best-match results from both documentation sections and test examples
    - Searches titles, content, examples, test names, descriptions, and file contents
    - Results ranked by relevance with content previews and URL fragments
    - Supports multiple keywords with enhanced scoring for matches
  - `get` - Get full content of a documentation section or test
    - Takes `type` ("documentation" or "test") and `id` (section ID or test name)
    - Returns complete structured content including all details
  - `evaluate` - Evaluate bkl files with given environment and return results
    - Takes `files` (comma-separated list), `format`, `environment`, `fileSystem`, `rootPath`, `workingDir`
    - Returns evaluated output in specified format
  - `diff` - Generate the minimal intermediate layer needed to create the target output from the base layer (bkld)
    - Takes `baseFile`, `targetFile`, `format`, `fileSystem`, `rootPath`
    - Returns diff output in specified format
  - `intersect` - Generate the maximal base layer that the specified targets have in common (bkli)
    - Takes `files` (comma-separated list, requires at least 2), `format`, `fileSystem`, `rootPath`
    - Returns intersect output in specified format
  - `required` - Generate a document containing just the required fields and their ancestors (bklr)
    - Takes `file`, `format`, `fileSystem`, `rootPath`
    - Returns required fields output in specified format
  - Uses embedded `tests.toml` and `docs/sections.yaml` for fast access
- Empty maps can be overridden by any value without error
- Cross-document merging follows filename inheritance patterns
- **Match behavior**: `$match` uses partial matching (`x: {}` matches any map with an `x` key)
- **Null handling**: `null` values are preserved and can override existing values
  - Empty YAML documents (which parse as null) are now preserved in output
  - Null values in lists are preserved (not filtered out)
  - Consistent behavior: null is treated like any other value, not as a special "delete" marker

## Output Directives
- `$output: true` marks content for inclusion in final output
- `$output: false` excludes content from final output
  - Uses a boolean return value to properly distinguish between "value is null" and "exclude from output"
- **Ambiguity resolution**: In maps within lists, presence of other keys determines scope
  - Map with only `$output: true` → applies to list
  - Map with `$output: true` + other keys → applies to map

## Interpolation Syntax
- String interpolation: `$"Hello {variable} world"`
- Environment variables: `$env:VARNAME` 
- Cross-document references and path navigation supported
- Missing variables properly return errors

## Repeat Functionality
- `$repeat` supports four modes: integer count, list of values, key-value map, and range parameters
- **Integer mode**: `$repeat: 5` creates 5 copies with `$repeat` variable as 0,1,2,3,4
- **List mode**: `$repeat: ["apple", "banana", "cherry"]` creates copies with `$repeat` variable as each list value
  - Works with any value type: strings, numbers, booleans, etc.
  - Example: `$repeat: [42, "hello", true]` iterates over mixed types
- **Key-value mode**: `$repeat: {x: 2, y: 3}` creates cross-product of iterations
- **Range parameters mode**: `$repeat: {$first: 5, $last: 10}` creates sequence with specific values
  - Supports `$first`, `$last`, `$count`, `$step` parameters
  - Must specify exactly 2 of `$first`, `$last`, `$count` (cannot specify all 3)
  - `$step` defaults to 1, cannot be 0
  - `$count` must be positive
  - For `$first`/`$last` combinations, validates that `(last-first) % step == 0`
- **Nested range parameters**: Key-value maps can contain range parameter objects
  - Example: `$repeat: {a: 2, b: {$first: 10, $step: 2, $count: 3}}` creates cross-product
  - Mixed integer and range parameter values are supported
- All repeat modes (integer, list, key-value map, range parameters) work in both document-level and object-level contexts
- When using `$repeat` in map keys, use string interpolation: `$"item-{$repeat}"`
- Variables created by key-value repeat can be accessed as `$repeat:keyname` in strings and interpolations

## Defer Functionality
- `$defer: true` marks a document for deferred processing
- Deferred documents are evaluated after all non-deferred documents have been fully processed
- This allows operations on the final output after transformations like `$repeat` have been applied
- Multiple deferred documents are evaluated in definition order
- Deferred documents with `$match` will match against the fully-processed output documents
- Useful for adding fields or modifications that depend on the final state after all processing

## MCP Servers Available
- **bkl-mcp** (Model Context Protocol server for documentation and test queries):
  - `query` - Unified query for bkl documentation and test examples by keywords (comma-separated)
    - Returns best-match results from both documentation sections and test examples
    - Searches titles, content, examples, test names, descriptions, and file contents
    - Results ranked by relevance with content previews and URL fragments
    - Supports multiple keywords with enhanced scoring for matches
  - `get` - Get full content of a documentation section or test
    - Takes `type` ("documentation" or "test") and `id` (section ID or test name)
    - Returns complete structured content including all details
  - Uses embedded `tests.toml` and `docs/sections.yaml` for fast access
- **language-server** (Model Context Protocol server for code analysis):
  - `mcp__language-server__definition` - Read source code definition of symbols (functions, types, methods)
  - `mcp__language-server__references` - Find all usages/references of a symbol throughout codebase
  - `mcp__language-server__hover` - Get type info and documentation for symbols
  - `mcp__language-server__diagnostics` - Get linting hints and diagnostics for files
  - `mcp__language-server__edit_file` - Apply text edits to files by line numbers
  - `mcp__language-server__rename_symbol` - Rename symbols and update all references
# Claude Code Memory - bkl Project

## Project Overview
bkl is a flexible configuration templating language that simplifies configuration management across environments. Key capabilities:
- **Multi-format support**: Handles YAML, JSON, TOML seamlessly
- **Automatic inheritance**: Uses filename patterns (e.g., `service.test.yaml` inherits from `service.yaml`)
- **Manual inheritance**: Via `$parent` directives and wildcard patterns
- **Intelligent merging**: Maps and lists merge by default, with override options
- **String interpolation**: `$"Hello {variable}"` syntax for dynamic values
- **Environment variables**: `$env:VAR` for runtime configuration
- **Transformations**: `$encode`, `$decode`, `$merge` for data manipulation
- **Stream processing**: Handle multiple documents with `$match` and `$output`
- **Utility features**: `$repeat`, `$delete`, `$replace`, required field validation

## Testing Framework
- Tests are in `tests/` directory, each test has its own subdirectory
- Test structure: `a.yaml` (input), `cmd` (command to run), `expected` (expected output)
- Use `./test` to run all tests or `./test <test-name>` for specific test
- For expected failures: use `! bkl` in cmd file and empty expected output
- Test naming patterns: `parent-*`, `interp-*`, `merge-*`, `encode-*`, etc.

## Key Files and Architecture
- `file.go`: File loading and parent resolution
- `document.go`: Document structure and processing
- `parser.go`: Main parser logic and document merging
- `process1.go`/`process2.go`: Document processing phases
- `merge.go`: Merge logic for combining documents and handling type conflicts
- `yaml.go`: YAML parsing using standard library decoder instead of regex
- `error.go`: Centralized error definitions with base `Err`

## Error Handling Patterns
- All errors inherit from base `Err` using `fmt.Errorf("message (%w)", Err)`
- Existing error types: `ErrCircularRef`, `ErrMissingFile`, `ErrVariableNotFound`, etc.
- Tests expecting failures use `! bkl` and empty expected output

## Code Style Observations
- Uses standard library `slices` package for modern Go idioms
- Error messages include context (file paths, variable names)
- Consistent naming: functions use camelCase, test directories use kebab-case
- Import organization: standard library first, then third-party

## Development Expectations
- **Minimal comments**: Only add comments when absolutely critical for disambiguation
- **Standard library preferred**: Use `slices.Contains()` instead of hand-rolled loops
- **Proper error handling**: Use `io.EOF` comparison, not string matching
- **Clean imports**: Remove unused imports, organize standard library first
- **Simple commits**: One-line commit messages, no "Generated by Claude" footers
- **Test-driven**: Write tests that demonstrate problems, then fix them
- **Standards compliance**: Prefer standard library implementations over custom parsing
- **Code quality**: The linter (`gofumpt`, `go vet`) will automatically format code
- **Comprehensive testing**: Use `just` to run the full test pipeline before committing
- **Configuration errors should fail with proper error messages, not silent success**
- **Always update CLAUDE.md**: After completing any task, update this file with new learnings
- **File maintenance**: Clean up and reorganize CLAUDE.md sections as needed during updates

## Commands for Development
- `just` - Run complete build and test pipeline (preferred)
  - Includes Go unit tests with race detection and coverage reporting
  - Runs integration tests via `./test`
  - Performs linting with `go vet` and formatting with `gofumpt`
  - Generates coverage report at `cover.html`
- `./test` - Run integration tests only
- `./test <test-name>` - Run specific integration test
- `go build ./cmd/bkl` - Build main binary
- Tests are comprehensive with 160+ integration tests plus Go unit tests

## Merge Behavior
- Maps merge recursively by default, with special `$replace` directive to override
- Lists append by default, with `$match`, `$delete`, and `$replace` directives for control
- **Type conflicts**: Non-map values (strings, numbers, etc.) override maps completely
  - Previous behavior: merging string into non-empty map would error
  - Current behavior: string overrides the entire map (implemented in `merge.go:47-48`)
- Empty maps can be overridden by any value without error
- Cross-document merging follows filename inheritance patterns

## Interpolation Syntax
- String interpolation: `$"Hello {variable} world"`
- Environment variables: `$env:VARNAME` 
- Cross-document references and path navigation supported
- Missing variables properly return errors